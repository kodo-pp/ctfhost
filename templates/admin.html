<!doctype html>
<html lang="{{ lc['lang_code'] }}" dir="ltr">
    <head>
        <link rel="shortcut icon" href="/static/favicon.png">
        <link rel="stylesheet" href="/static/w3css/w3.css">
        <link rel="stylesheet" href="/static/ctfhost-common.css">
        <link rel="stylesheet" href="/static/task-editor.css">
        <script>
            locale_messages = {% raw str(lc) %}; /* should work */
        </script>
        <script src="/static/admin/task-editor.js"></script>
        <script src="/static/http-request.js"></script>
        <meta charset="utf-8">
        <title>{{ conf['ctfname'] }} - {{ lc['admin_page'] }}</title>
        <script>
            function select_tab(tab_name)
            {
                let tabs = document.querySelectorAll('#tabset>.w3-bar-item');
                for (let tab of tabs) {
                    if (tab.id == 'tab-' + tab_name) {
                        tab.classList.remove('w3-button');
                        tab.classList.add('w3-green');
                    } else {
                        tab.classList.add('w3-button');
                        tab.classList.remove('w3-green');
                    }
                }

                let tabcontents = document.querySelectorAll('#tabcontents>div');
                for (let tabc of tabcontents) {
                    if (tabc.id == 'tabcontent-' + tab_name) {
                        tabc.classList.remove('hidden');
                    } else {
                        tabc.classList.add('hidden');
                    }
                }
            }

            function setup_tabs()
            {
                let tabs = document.querySelectorAll('#tabset>.w3-bar-item');
                for (let tab of tabs) {
                    let tab_name = tab.id.replace(/^tab-/, '');
                    tab.addEventListener('click', function() {
                        select_tab(tab_name);
                    });
                }
                select_tab('tasks');
            }

            function load_task(task_id)
            {
                return make_http_request('/api/get_task', JSON.stringify({'task_id': task_id}));
            }

            function mkseed()
            {
                let a = new Uint8Array(8);
                crypto.getRandomValues(a);
                let hex_str = '';
                const alp = '0123456789abcdef';
                for (let b of a) {
                    hex_str += (alp[(b & 0xF0) >> 4]);
                    hex_str += (alp[b & 0xF]);
                }
                return hex_str;
            }

            function edit_task(task_id)
            {
                setTimeout(function() {
                    try {
                        let text = null;
                        let title = null;
                        let value = null;
                        let labels = [];
                        let loaded_flags = [];
                        let group = 0;
                        let order = 0;
                        let seed = mkseed();
                        if (task_id !== null) {
                            let loaded_task = load_task(task_id);
                            text = loaded_task.task.text;
                            title = loaded_task.task.title;
                            value = loaded_task.task.value;
                            labels = loaded_task.task.labels;
                            group = loaded_task.task.group;
                            loaded_flags = loaded_task.task.flags;
                            order = loaded_task.task.order;
                            seed = loaded_task.task.seed;
                        }
                        open_task_editor(task_id, text, title, value, labels, loaded_flags, group, order, seed);
                    } catch (e) {
                        error_message(e.message);
                        throw e;
                    }
                }, 0);
            }

            function delete_task(task_id)
            {
                if (!confirm('{{ lc['confirm_task_deletion'] }}')) {
                    return false;
                }

                let response;
                try {
                    response = make_http_request('/api/delete_task', JSON.stringify({'task_id': task_id}));
                } catch (e) {
                    if (e instanceof ActionError) {
                        error_message(e.message);
                        return;
                    } else {
                        throw e;
                    }
                }
                location.reload();
            }

            function error_message(msg)
            {
                let error_message = '{{ lc['error'] }}: ' + msg;
                alert(error_message);
            }
    
            function change_password(team_name)
            {
                if (!confirm('{{ lc['change_password_confirm_msg'] }}')) {
                    return;
                }
                let new_password = document.getElementById(`new-password-${team_name}`).value;
                try {
                    make_http_request('/api/change_password', JSON.stringify({
                        'team_name': team_name,
                        'new_password': new_password,
                        'old_password': "doesn't matter"
                    }));
                    alert('{{ lc['password_changed_successfully'] }}');
                } catch (e) {
                    error_message(e.message);
                }
            }

            function logout_team(team_name)
            {
                if (!confirm('{{ lc['logout_team_confirm_msg'] }}')) {
                    return;
                }
                try {
                    make_http_request('/api/logout_team', JSON.stringify({
                        'team_name': team_name
                    }));
                    alert('{{ lc['team_logged_out_successfully'] }}');
                } catch (e) {
                    error_message(e.message);
                }
            }

            function delete_team(team_name)
            {
                if (!confirm('{{ lc['delete_team_confirm_msg'] }}')) {
                    return;
                }
                try {
                    make_http_request('/api/delete_team', JSON.stringify({
                        'team_name': team_name
                    }));
                    location.reload();
                } catch (e) {
                    error_message(e.message);
                }
            }
            
            function add_group(parent_id)
            {
                let name = document.getElementById(`add-group-name${parent_id}`).value;
                let data = {
                    'parent': parent_id,
                    'name': name
                };
                try {
                    make_http_request('/api/add_group', JSON.stringify(data));
                    location.reload();
                } catch (e) {
                    error_message(e.message);
                }
            }

            function rename_group(group_id)
            {
                let new_name = document.getElementById(`rename-group-name${group_id}`).value;
                let data = {
                    'group_id': group_id,
                    'new_name': new_name
                };
                try {
                    make_http_request('/api/rename_group', JSON.stringify(data));
                    location.reload();
                } catch (e) {
                    error_message(e.message);
                }
            }

            function update_group_parent(group_id)
            {
                let new_parent = document.getElementById(`group-parent${group_id}`).value;
                let data = {
                    'group_id': group_id,
                    'new_parent': new_parent
                };
                try {
                    make_http_request('/api/reparent_group', JSON.stringify(data));
                    location.reload();
                } catch (e) {
                    error_message(e.message);
                }
            }

            function delete_group(group_id)
            {
                if (!confirm("{{ lc['confirm_group_deletion'] }}")) {
                    return;
                }
                let data = {
                    'group_id': group_id
                };
                try {
                    make_http_request('/api/delete_group', JSON.stringify(data));
                    location.reload();
                } catch (e) {
                    error_message(e.message);
                }
            }

            function setup_group_parents()
            {
                {% for group in groups.values() %}
                    document.getElementById('group-parent{{ group['group_id'] }}').value = {{ group['parent'] }};
                {% end %}
            }

            function taskeditor_randomize_seed()
            {
                let in_seed = document.getElementById('task-editor-seed-input');
                in_seed.value = mkseed();
            }

            window.addEventListener('load', setup_tabs);
            window.addEventListener('load', setup_group_parents);
        </script>
    </head>
    <body>
        <div id="task-editor-overlay">
            <div id="task-editor-box">
                <h3>{{ lc['task_editor'] }}</h3>
                <input type="hidden" id="task-editor-taskid-input">
                <p>
                    <label for="task-editor-title-input">{{ lc['taskeditor_title'] }}</label>
                    <input
                        type="text"
                        id="task-editor-title-input"
                        placeholder="{{ lc['taskeditor_title'] }}"
                        class="w3-input w3-border"
                        required
                    >
                </p>
                <p>
                    <label for="task-editor-value-input">{{ lc['taskeditor_value'] }}</label>
                    <input
                        type="number"
                        step=1
                        id="task-editor-value-input"
                        placeholder="{{ lc['taskeditor_value'] }}"
                        class="w3-input w3-border"
                        pattern="[1-9][0-9]*"
                        required
                    >
                </p>
                <p>
                    <label for="task-editor-labels-input">{{ lc['taskeditor_labels'] }}</label>
                    <input
                        type="text"
                        id="task-editor-labels-input"
                        placeholder="{{ lc['taskeditor_labels'] }}"
                        class="w3-input w3-border"
                    >
                </p>
                <p>
                    <label for="task-editor-groupname-input">{{ lc['taskeditor_group'] }}</label>
                    <select id="task-editor-groupname-input" class="w3-input w3-border">
                        <option value="0">
                            {{ lc['root_group'] }}
                        </option>
                        {% for group in groups.values() %}
                            <option value="{{ group['group_id'] }}">
                                {{ group['name'] }}
                            </option>
                        {% end %}
                    </select>
                </p>
                <p>
                    <label for="task-editor-text-input">{{ lc['taskeditor_text'] }}</label>
                    <textarea id="task-editor-text-input" class="w3-input w3-border">
                    </textarea>
                </p>
                <p>
                    <label for="task-editor-seed-input">{{ lc['taskeditor_seed'] }}</label>
                    <div class="w3-row-padding">
                        <div class="w3-col s9 m9 l9">
                            <input
                                type="text"
                                id="task-editor-seed-input"
                                placeholder="{{ lc['taskeditor_seed'] }}"
                                class="w3-input w3-border"
                                regex="[0-9a-f]{16}"
                                required
                            >
                        </div>
                        <div class="w3-col s3 m3 l3">
                            <a class="w3-button w3-green block" href="javascript:taskeditor_randomize_seed()">
                                {{ lc['taskeditor_randomize_seed'] }}
                            </a>
                        </div>
                    </div>
                </p>
                <p>{{ lc['flags'] }}</p>
                <div id="task-editor-flags"></div> <!-- Filled by task-editor.js -->
                <p>
                    <a href="javascript:add_flag()" class="w3-button w3-green">{{ lc['add_flag'] }}</a>
                </p>
                <p>
                    <label for="task-editor-order-input">{{ lc['taskeditor_order'] }}</label>
                    <input
                        type="number"
                        step="1"
                        id="task-editor-order-input"
                        placeholder="{{ lc['taskeditor_order'] }}"
                        class="w3-input w3-border"
                        pattern="[1-9][0-9]*"
                        value="0"
                        required
                    >
                </p>
                <p>
                    <a id="task-editor-cancel-button" class="w3-button w3-red">{{ lc['taskeditor_cancel'] }}</a>
                    <a id="task-editor-submit-button" class="w3-button w3-green">{{ lc['taskeditor_submit'] }}</a>
                </p>
            </div>
        </div>
        <div class="w3-bar w3-dark-grey">
            <a class="w3-bar-item w3-button" href="/">{{ lc['home_page'] }}</a>
            <a class="w3-bar-item w3-button" href="/tasks">{{ lc['tasks'] }}</a>
            <a class="w3-bar-item w3-button" href="/team_profile?team={{ session.username }}">
                {{ lc['team_profile'] }}
            </a>
            <a class="w3-bar-item w3-button" href="/scoreboard">{{ lc['scoreboard'] }}</a>
            <span class="w3-bar-item w3-green">{{ lc['admin_page'] }}</span>
            <a class="w3-bar-item w3-button w3-right" href="/lout">{{ lc['logout'] }}</a>
            <span class="w3-bar-item w3-light-grey w3-right">
                {{ lc['signed_in_as'].format(session.username) }}
            </span>
        </div>
        <div class="w3-container">
            <h1>{{ lc['admin_page'] }}</h1>
            <div class="w3-bar w3-dark-grey" id="tabset">
                <span class="w3-bar-item w3-button" id="tab-tasks">{{ lc['admintab_tasks'] }}</span>
                <span class="w3-bar-item w3-button" id="tab-groups">{{ lc['admintab_groups'] }}</span>
                <span class="w3-bar-item w3-button" id="tab-task-gen">{{ lc['admintab_task_gen'] }}</span>
                <span class="w3-bar-item w3-button" id="tab-teams">{{ lc['admintab_teams'] }}</span>
                <span class="w3-bar-item w3-button" id="tab-submissions">{{ lc['admintab_submissions'] }}</span>
            </div>
            <div id="tabcontents">
                <div class="w3-container hidden" id="tabcontent-groups">
                    <h2>{{ lc['admintab_groups'] }}</h2>
                    <p>
                    <div class="w3-row-padding">
                        <div class="w3-col s9 m9 l9">
                            <input
                                type="text"
                                id="add-group-name0"
                                class="w3-input w3-border"
                                placeholder="{{ lc['group_name'] }}">
                        </div>
                        <div class="w3-col s3 m3 l3">
                            <a
                                class="w3-button w3-green block"
                                href="javascript:add_group(0)"
                            >
                                {{ lc['add_group'] }}
                            </a>
                        </div>
                    </div>
                    </p>
                    {% for group in groups.values() %}
                        <p>
                        <div class="w3-container w3-light-grey" style="padding-bottom: 10px;">
                            <span style="color: grey;">
                                {% try %}
                                    {{ '/'.join(build_group_path(groups, group['group_id'])[:-1]) + '/' }}
                                {% except BaseException as e %}
                                    {{ lc['error_building_group_path'] }}
                                {% end %}
                            </span>
                            <h3>{{ group['name'] }}</h3>
                            <p>
                            <div class="w3-row-padding">
                                <div class="w3-col s8 m8 l8">
                                    <input
                                        type="text"
                                        id="add-group-name{{ group['group_id'] }}"
                                        class="w3-input w3-border"
                                        placeholder="{{ lc['group_name'] }}">
                                    </div>
                                <div class="w3-col s4 m4 l4">
                                    <a
                                        class="w3-button w3-green block"
                                        href="javascript:add_group({{ group['group_id'] }})"
                                    >
                                        {{ lc['add_subgroup'] }}
                                    </a>
                                </div>
                            </div>
                            </p>
                            <p>
                            <div class="w3-row-padding">
                                <div class="w3-col s8 m8 l8">
                                    <input
                                        type="text"
                                        id="rename-group-name{{ group['group_id'] }}"
                                        class="w3-input w3-border"
                                        placeholder="{{ lc['group_new_name'] }}">
                                </div>
                                <div class="w3-col s4 m4 l4">
                                    <a
                                        class="w3-button w3-green block"
                                        href="javascript:rename_group({{ group['group_id'] }})"
                                    >
                                        {{ lc['rename_group'] }}
                                    </a>
                                </div>
                            </div>
                            </p>
                            <h5>{{ lc['parent_group'] }}</h5>
                            <div class="w3-row-padding">
                                <div class="w3-col s8 m8 l8">
                                    <select
                                        class="w3-input w3-border"
                                        id="group-parent{{ group['group_id'] }}"
                                    >
                                        <option value="0">
                                            {{ lc['root_group'] }}
                                        </option>
                                        {% for parent in groups.values() %}
                                            {% if group['group_id'] != parent['group_id'] %}
                                                <option value="{{ parent['group_id'] }}">
                                                    {{ parent['name'] }}
                                                    </option>
                                            {% end %}
                                        {% end %}
                                    </select>
                                </div>
                                <div class="w3-col s4 m4 l4">
                                    <a
                                        href="javascript:update_group_parent({{ group['group_id'] }})"
                                        class="w3-button w3-green block"
                                    >
                                        {{ lc['update_group_parent'] }}
                                    </a>
                                </div>
                            </div>
                            <p>
                                <h5>{{ lc['subgroups'] }}</h5>
                                <ul class="w3-ul">
                                    {% set any_subgroup = False %}
                                    {% for subgroup in groups.values() %}
                                        {% if subgroup['parent'] == group['group_id'] %}
                                            {% set any_subgroup = True %}
                                            <li>{{ subgroup['name'] }}</li>
                                        {% end %}
                                    {% end %}
                                    {% if not any_subgroup %}
                                        <p style="padding-left: 10px">
                                            <em>{{ lc['empty_list'] }}</em>
                                        </p>
                                    {% end %}
                                </ul>
                            </p>
                            <p>
                                <h5>{{ lc['subtasks'] }}</h5>
                                <ul class="w3-ul">
                                    {% set any_task = False %}
                                    {% for task in tasks %}
                                        {% if task.group == group['group_id'] %}
                                            {% set any_task = True %}
                                            <li>{{ task.title }}</li>
                                        {% end %}
                                    {% end %}
                                    {% if not any_task %}
                                        <p style="padding-left: 10px">
                                            <em>{{ lc['empty_list'] }}</em>
                                        </p>
                                    {% end %}
                                </ul>
                            </p>
                            <p>
                                <a
                                    href="javascript:delete_group({{ group['group_id'] }})"
                                    class="w3-button w3-red"
                                >
                                    {{ lc['delete_group'] }}
                                </a>
                            </p>
                        </div>
                        </p>
                    {% end %}
                </div>
                <div class="w3-container hidden" id="tabcontent-tasks">
                    <h2>{{ lc['admintab_tasks'] }}</h2>
                    <p>
                        <a class="w3-button w3-green" href="javascript:edit_task(null)">
                            {{ lc['admin_task_add'] }}
                        </a>
                    </p>
                    {% for task in tasks %}
                        <div class="w3-container w3-light-grey" style="margin: 10px 0 10px 0;">
                            <span style="color: grey;">
                                {% try %}
                                    {{ '/'.join(build_group_path(groups, task.group)) + '/' }}
                                {% except BaseException as e %}
                                    {{ lc['error_building_group_path'] }}
                                {% end %}
                            </span>
                            <h3>{{ task.title }} [{{ task.value }}]</h3>
                            <p>
                                <a
                                    class="w3-button w3-blue"
                                    onclick="edit_task({{ task.task_id }})"
                                >{{ lc['admin_task_edit'] }}</a>
                                <a
                                    class="w3-button w3-red"
                                    onclick="delete_task({{ task.task_id }})"
                                >{{ lc['admin_task_delete'] }}</a>
                            </p>
                        </div>
                    {% end %}
                </div>
                <div class="w3-container hidden" id="tabcontent-teams">
                    <h2>{{ lc['admintab_teams'] }}</h2>
                    <a class="w3-button w3-green" href="/admin_new_team">
                        {{ lc['register_new_team'] }}
                    </a>
                    {% for team in teams %}
                        <div class="w3-light-grey w3-container" style="margin: 10px 0px 10px 0px">
                            <h3>{{ team.full_name }}</h3>
                            <p><strong>{{ lc['nickname'] }}</strong>: {{ team.team_name }}</p>
                            <p><a
                                class="w3-button w3-blue"
                                href="/team_profile?team={{ team.team_name }}"
                            >{{ lc['view_profile'] }}</a></p>
                            <div class="w3-row">
                                <div class="w3-col s10 m10 w10">
                                    <input
                                        type="password"
                                        placeholder="{{ lc['new_password'] }}"
                                        class="w3-input w3-border"
                                        id="new-password-{{ team.team_name }}"
                                    >
                                </div>
                                <div class="w3-col s2 m2 w2">
                                    <a
                                        class="w3-button w3-green"
                                        href="javascript:change_password('{{ team.team_name }}')"
                                    >
                                        {{ lc['change_password'] }}
                                    </a>
                                </div>
                            </div>
                            <p>
                                <a
                                    class="w3-button w3-red"
                                    href="javascript:delete_team('{{ team.team_name }}')"
                                >
                                    {{ lc['delete_team'] }}
                                </a>
                                <a
                                    class="w3-button w3-deep-orange"
                                    href="javascript:logout_team('{{ team.team_name }}')"
                                >
                                    {{ lc['logout_team'] }}
                                </a>
                            </p>
                        </div>
                    {% end %}
                </div>
                <div class="w3-container hidden" id="tabcontent-submissions">
                    <h2>{{ lc['admintab_submissions'] }}</h2>
                    <table class="w3-table w3-border w3-striped">
                        <tr>
                            <th>{{ lc['team_name'] }}</th>
                            <th>{{ lc['task_name'] }}</th>
                            <th>{{ lc['submitted_flag'] }}</th>
                            <th>{{ lc['is_correct'] }}</th>
                            <th>{{ lc['points'] }}</th>
                            <th>{{ lc['submission_time'] }}</th>
                        </tr>
                        {% for sub in reversed(sorted(submissions, key = lambda x: x['time'])) %}
                            {% try %}
                                {% set task = read_task(sub['task_id']) %}
                                <tr>
                                    <td>{{ sub['team_name'] }}</td>
                                    <td>{{ task.title }}</td>
                                    <td style="font-family: monospace">{{ sub['flag'] }}</td>
                                    {% if sub['is_correct'] %}
                                        <td class="w3-text-green">{{ lc['yes'] }}</td>
                                    {% else %}
                                        <td class="w3-text-red">{{ lc['no'] }}</td>
                                    {% end %}
                                    <td>{{ sub['points'] }}</td>
                                    <td>{{ conf['date_fmt_func'](sub['time']) }}</td>
                                </tr>
                            {% except KeyError %}
                            {% end %}
                        {% end %}
                    </table>
                </div>
                <div class="w3-container hidden" id="tabcontent-task-gen">
                    <h2>{{ lc['admintab_task_gen'] }}</h2>
                    {% for task in tasks %}
                        <div class="w3-container w3-light-grey" style="margin: 10px 0 10px 0;">
                            <span style="color: grey;">
                                {% try %}
                                    {{ '/'.join(build_group_path(groups, task.group)) + '/' }}
                                {% except BaseException as e %}
                                    {{ lc['error_building_group_path'] }}
                                {% end %}
                            </span>
                            <h3>{{ task.title }}</h3>
                            <p>
                                <strong>{{ lc['task_token_seed'] }}:</strong>
                                <code style="font-family: monospace">{{ task.seed }}</code>
                            </p>
                        </div>
                    {% end %}
                </div>
            </div>
        </div>
    </body>
</html>
